<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SusiPedia</title>
  <link rel="shortcut icon" href="icon.png" type="image/x-icon" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="index.css">
</head>
<body class="index">

<div class="header">
  <div class="logo">
    <img src="logo.png" alt="SusiPedia">
  </div>
  <p>The Free Ensusipedia</p>

  <div class="search-bar">
    <input id="searchInput" type="search" placeholder="Search SusiPedia">
    <button id="searchBtn">Search</button>
  </div>
</div>

<div class="main">

  <div class="panel articles-panel">
    <h2>Articles</h2>
    <ul id="articles-list" class="articles-list">
      <li class="loading">Loading articles…</li>
    </ul>
  </div>

  <div class="panel">
    <h2>Welcome to SusiPedia</h2>
    <p>SusiPedia is a free encyclopedia documenting people, politics, science, and more across the world. For breaking news, please go to <b>SusFeed.com</b>.</p>
    <ul>
      <li><span id="articleCount">Loading…</span> articles</li>
    </ul>
  </div>

  <div class="panel">
    <h2>Navigation</h2>
    <ul>
      <li><a href="../index.html">SusFeed</a></li>
      <li><a href="articles.html">List of Articles</a></li>
      <li><a href="#" id="randomArticleBtn">Random sus page</a></li>
    </ul>
  </div>

</div>

<footer>
  Text is available under the Sus Attribution-ShareAlike License
</footer>

<div id="searchResults" class="search-results hidden">
  <div class="search-results-box">
    <div class="search-results-header">
      <span id="resultsTitle">Search results</span>
      <button id="closeResults">✕</button>
    </div>
    <ul id="resultsList" class="articles-list"></ul>
  </div>
</div>

<script>
let allArticles = [];

const list = document.getElementById("articles-list");
const input = document.getElementById("searchInput");
const button = document.getElementById("searchBtn");

const overlay = document.getElementById("searchResults");
const resultsList = document.getElementById("resultsList");
const closeBtn = document.getElementById("closeResults");
const title = document.getElementById("resultsTitle");

const articleCountEl = document.getElementById("articleCount");
const randomBtn = document.getElementById("randomArticleBtn");

fetch("articles/articles.json")
  .then(res => res.json())
  .then(articles => {
    allArticles = articles;

    const maxId = Math.max(...articles.map(a => a.id));
    articleCountEl.textContent = maxId.toLocaleString();

    renderHomeArticles(articles.slice().reverse().slice(0, 10));
  });

function renderHomeArticles(articles) {
  list.innerHTML = "";
  articles.forEach(article => {
    const li = document.createElement("li");
    const a = document.createElement("a");
    a.href = `articles/content/${article.file}`;
    a.textContent = article.title;
    li.appendChild(a);
    list.appendChild(li);
  });
}

function renderResults(articles, fallback = false) {
  resultsList.innerHTML = "";

  if (articles.length === 0) {
    resultsList.innerHTML = "<li class='error'>No results found</li>";
    return;
  }

  title.textContent = fallback
    ? "No exact matches — closest results"
    : "Search results";

  articles.forEach(article => {
    const li = document.createElement("li");
    const a = document.createElement("a");
    a.href = `articles/content/${article.file}`;
    a.textContent = article.title;
    li.appendChild(a);
    resultsList.appendChild(li);
  });
}

function score(title, query) {
  title = title.toLowerCase();
  query = query.toLowerCase();
  let s = 0;
  for (let c of query) if (title.includes(c)) s++;
  return s;
}

function runSearch() {
  const query = input.value.trim().toLowerCase();
  if (!query) return;

  let results = allArticles.filter(a =>
    a.title.toLowerCase().includes(query)
  );

  let fallback = false;

  if (results.length === 0) {
    fallback = true;
    results = allArticles
      .map(a => ({ ...a, s: score(a.title, query) }))
      .sort((a, b) => b.s - a.s)
      .slice(0, 8)
      .filter(a => a.s > 0);
  }

  renderResults(results, fallback);
  overlay.classList.remove("hidden");
}

button.addEventListener("click", runSearch);
input.addEventListener("keydown", e => {
  if (e.key === "Enter") runSearch();
});

closeBtn.addEventListener("click", () => {
  overlay.classList.add("hidden");
});

overlay.addEventListener("click", e => {
  if (e.target === overlay) overlay.classList.add("hidden");
});

function goToRandomArticle() {
  if (!allArticles.length) return;

  const random =
    allArticles[Math.floor(Math.random() * allArticles.length)];

  window.location.href = `articles/content/${random.file}`;
}

randomBtn.addEventListener("click", e => {
  e.preventDefault();
  goToRandomArticle();
});
</script>

<script src="index.js"></script>

</body>
</html>
